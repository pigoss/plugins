{"version":3,"sources":["../src/table_ctrl.js"],"names":["angular","_","$","moment","FileExport","MetricsPanelCtrl","transformDataToTable","tablePanelEditor","columnOptionsTab","TableRenderer","panelDefaults","targets","transform","pageSize","showHeader","styles","type","pattern","alias","dateFormat","headerColor","unit","decimals","colors","colorMode","thresholds","columns","scroll","fontSize","sort","col","desc","TableCtrl","$scope","$injector","pageIndex","panel","fields","defaults","events","on","onDataReceived","bind","onDataError","onInitEditMode","onInitPanelActions","addEditorTab","actions","push","text","click","datasource","setTimeQueryStart","annotationsSrv","getAnnotations","dashboard","range","then","data","annotations","err","dataRaw","render","dataList","length","table","renderer","isTimezoneUtc","$sanitize","colIndex","exportTableDataToCsv","render_values","scope","elem","attrs","ctrl","pageCount","formaters","getTableHeight","panelHeight","height","appendTableRows","tbodyElem","setTable","empty","html","switchPage","e","el","currentTarget","parseInt","renderPanel","appendPaginationControls","footerElem","Math","ceil","rows","startPage","max","endPage","min","paginationList","i","activeClass","pageLinkElem","append","panelElem","parents","rootElem","find","tbodyTopElem","css","addClass","unbindDestroy","$on","off","renderData","renderingCompleted","templateUrl"],"mappings":"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","file":"table_ctrl.js","sourcesContent":["import angular from 'angular';\r\nimport _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport moment from 'moment';\r\nimport * as FileExport from 'app/core/utils/file_export';\r\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport {transformDataToTable} from './transformers';\r\nimport {tablePanelEditor} from './editor';\r\nimport {columnOptionsTab} from './column_options';\r\nimport {TableRenderer} from './renderer';\r\nimport './css/style.css!';\r\n\r\nconst panelDefaults = {\r\n  targets: [{}],\r\n  transform: 'timeseries_to_columns',\r\n  pageSize: null,\r\n  showHeader: true,\r\n  styles: [\r\n    {\r\n      type: 'date',\r\n      pattern: 'Time',\r\n      alias: 'Time',\r\n      dateFormat: 'YYYY-MM-DD HH:mm:ss',\r\n      headerColor: \"rgba(51, 181, 229, 1)\"\r\n    },\r\n    {\r\n      unit: 'short',\r\n      type: 'number',\r\n      alias: '',\r\n      decimals: 2,\r\n      headerColor: \"rgba(51, 181, 229, 1)\",\r\n      colors: [\"rgba(245, 54, 54, 0.9)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(50, 172, 45, 0.97)\"],\r\n      colorMode: null,\r\n      pattern: '/.*/',\r\n      thresholds: [],\r\n    }\r\n  ],\r\n  columns: [],\r\n  scroll: true,\r\n  fontSize: '100%',\r\n  sort: { col: 0, desc: true },\r\n};\r\n\r\nexport class TableCtrl extends MetricsPanelCtrl {\r\n  constructor($scope, $injector) {\r\n    super($scope, $injector);\r\n    this.pageIndex = 0;\r\n\r\n    if (this.panel.styles === void 0) {\r\n      this.panel.styles = this.panel.columns;\r\n      this.panel.columns = this.panel.fields;\r\n      delete this.panel.columns;\r\n      delete this.panel.fields;\r\n    }\r\n\r\n    _.defaults(this.panel, panelDefaults);\r\n\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\r\n\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.addEditorTab('表格设置', tablePanelEditor, 2);\r\n    this.addEditorTab('列样式', columnOptionsTab, 3);\r\n  }\r\n\r\n  onInitPanelActions(actions) {\r\n    actions.push({ text: 'Export CSV', click: 'ctrl.exportCsv()' });\r\n  }\r\n\r\n  issueQueries(datasource) {\r\n    this.pageIndex = 0;\r\n\r\n    if (this.panel.transform === 'annotations') {\r\n      this.setTimeQueryStart();\r\n      return this.annotationsSrv.getAnnotations({ dashboard: this.dashboard, panel: this.panel, range: this.range })\r\n        .then(annotations => {\r\n          return { data: annotations };\r\n        });\r\n    }\r\n\r\n    return super.issueQueries(datasource);\r\n  }\r\n\r\n  onDataError(err) {\r\n    this.dataRaw = [];\r\n    this.render();\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    this.dataRaw = dataList;\r\n    this.pageIndex = 0;\r\n\r\n    // automatically correct transform mode based on data\r\n    if (this.dataRaw && this.dataRaw.length) {\r\n      if (this.dataRaw[0].type === 'table') {\r\n        this.panel.transform = 'table';\r\n      } else {\r\n        if (this.dataRaw[0].type === 'docs') {\r\n          this.panel.transform = 'json';\r\n        } else {\r\n          if (this.panel.transform === 'table' || this.panel.transform === 'json') {\r\n            this.panel.transform = 'timeseries_to_rows';\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    this.render();\r\n  }\r\n\r\n  render() {\r\n    this.table = transformDataToTable(this.dataRaw, this.panel);\r\n    this.table.sort(this.panel.sort);\r\n\r\n    this.renderer = new TableRenderer(this.panel, this.table, this.dashboard.isTimezoneUtc(), this.$sanitize);\r\n\r\n    return super.render(this.table);\r\n  }\r\n\r\n  toggleColumnSort(col, colIndex) {\r\n    // remove sort flag from current column\r\n    if (this.table.columns[this.panel.sort.col]) {\r\n      this.table.columns[this.panel.sort.col].sort = false;\r\n    }\r\n\r\n    if (this.panel.sort.col === colIndex) {\r\n      if (this.panel.sort.desc) {\r\n        this.panel.sort.desc = false;\r\n      } else {\r\n        this.panel.sort.col = null;\r\n      }\r\n    } else {\r\n      this.panel.sort.col = colIndex;\r\n      this.panel.sort.desc = true;\r\n    }\r\n    this.render();\r\n  }\r\n\r\n  exportCsv() {\r\n    FileExport.exportTableDataToCsv(this.renderer.render_values());\r\n  }\r\n\r\n  link(scope, elem, attrs, ctrl) {\r\n    var data;\r\n    var panel = ctrl.panel;\r\n    var pageCount = 0;\r\n    var formaters = [];\r\n\r\n    function getTableHeight() {\r\n      var panelHeight = ctrl.height;\r\n\r\n      if (pageCount > 1) {\r\n        panelHeight -= 26;\r\n      }\r\n\r\n      return (panelHeight - 31) + 'px';\r\n    }\r\n\r\n    function appendTableRows(tbodyElem) {\r\n      ctrl.renderer.setTable(data);\r\n      tbodyElem.empty();\r\n      tbodyElem.html(ctrl.renderer.render(ctrl.pageIndex));\r\n    }\r\n\r\n    function switchPage(e) {\r\n      var el = $(e.currentTarget);\r\n      ctrl.pageIndex = (parseInt(el.text(), 10) - 1);\r\n      renderPanel();\r\n    }\r\n\r\n    function appendPaginationControls(footerElem) {\r\n      footerElem.empty();\r\n\r\n      var pageSize = panel.pageSize || 100;\r\n      pageCount = Math.ceil(data.rows.length / pageSize);\r\n      if (pageCount === 1) {\r\n        return;\r\n      }\r\n\r\n      var startPage = Math.max(ctrl.pageIndex - 3, 0);\r\n      var endPage = Math.min(pageCount, startPage + 9);\r\n\r\n      var paginationList = $('<ul></ul>');\r\n\r\n      for (var i = startPage; i < endPage; i++) {\r\n        var activeClass = i === ctrl.pageIndex ? 'active' : '';\r\n        var pageLinkElem = $('<li><a class=\"table-panel-page-link pointer ' + activeClass + '\">' + (i + 1) + '</a></li>');\r\n        paginationList.append(pageLinkElem);\r\n      }\r\n\r\n      footerElem.append(paginationList);\r\n    }\r\n\r\n    function renderPanel() {\r\n      var panelElem = elem.parents('.panel');\r\n      var rootElem = elem.find('.table-panel-scroll');\r\n      var tbodyTopElem = elem.find('.table-panel-table-head tbody');\r\n      var tbodyElem = elem.find('.table-panel-table-body tbody');\r\n      var footerElem = elem.find('.table-panel-footer');\r\n\r\n      elem.css({ 'font-size': panel.fontSize });\r\n      panelElem.addClass('table-panel-wrapper');\r\n\r\n      appendTableRows(tbodyTopElem);\r\n      appendTableRows(tbodyElem);\r\n      appendPaginationControls(footerElem);\r\n\r\n      rootElem.css({ 'max-height': panel.scroll ? getTableHeight() : '' });\r\n    }\r\n\r\n    elem.on('click', '.table-panel-page-link', switchPage);\r\n\r\n    var unbindDestroy = scope.$on('$destroy', function () {\r\n      elem.off('click', '.table-panel-page-link');\r\n      unbindDestroy();\r\n    });\r\n\r\n    ctrl.events.on('render', function (renderData) {\r\n      data = renderData || data;\r\n      if (data) {\r\n        renderPanel();\r\n      }\r\n      ctrl.renderingCompleted();\r\n    });\r\n  }\r\n}\r\n\r\nTableCtrl.templateUrl = 'module.html';\r\n"]}